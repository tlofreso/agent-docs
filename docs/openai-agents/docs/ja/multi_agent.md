---
search:
  exclude: true
---
# 複数のエージェントのオーケストレーション

オーケストレーションとは、アプリにおけるエージェントの流れのことです。どのエージェントをどの順序で実行し、次に何をするかをどのように決定するか、ということです。エージェントをオーケストレーションする方法は主に 2 つあります。

1. LLM に意思決定させる: LLM の知能を使って計画・推論し、それに基づいて次の手順を決めます。
2. コードでオーケストレーションする: コードでエージェントの流れを決定します。

これらのパターンは組み合わせて使えます。それぞれにトレードオフがあります（下記参照）。

## LLM によるオーケストレーション

エージェントは、指示・ツール・ハンドオフを備えた LLM です。これは、オープンエンドなタスクが与えられたときに、LLM が自律的にタスクへの取り組み方を計画し、ツールで行動やデータ取得を行い、ハンドオフでサブエージェントにタスクを委任できることを意味します。たとえば、リサーチ用のエージェントには次のようなツールを備えられます。

-   Web 検索でオンライン情報を探す
-   ファイル検索と取得でプロプライエタリデータや接続先を横断的に検索する
-   コンピュータ操作でコンピュータ上のアクションを実行する
-   コード実行でデータ分析を行う
-   計画立案やレポート作成などに長けた専門エージェントへのハンドオフ

このパターンは、タスクがオープンエンドで LLM の知能に依存したい場合に適しています。重要な戦術は次のとおりです。

1. 良いプロンプトに投資します。利用可能なツール、その使い方、遵守すべきパラメーターを明確にします。
2. アプリを監視して反復改善します。うまくいかない箇所を見つけ、プロンプトを改善します。
3. エージェントが内省・改善できるようにします。たとえばループで実行して自己批評させる、あるいはエラーメッセージを与えて改善させます。
4. 何でもこなす汎用エージェントではなく、単一タスクに特化して卓越したエージェントを用意します。
5. [evals](https://platform.openai.com/docs/guides/evals) に投資します。これにより、エージェントを鍛えてタスクの上達を図れます。

## コードによるオーケストレーション

LLM によるオーケストレーションは強力ですが、コードでオーケストレーションすると、速度・コスト・性能の面でより決定的かつ予測可能になります。一般的なパターンは次のとおりです。

-   [structured outputs](https://platform.openai.com/docs/guides/structured-outputs) を用いて、コードで検査できる適切な形式のデータを生成します。たとえば、エージェントにタスクをいくつかのカテゴリーに分類させ、カテゴリーに応じて次のエージェントを選びます。
-   複数のエージェントを連結し、あるエージェントの出力を次のエージェントの入力に変換します。ブログ記事の執筆のようなタスクを、リサーチ→アウトライン作成→本文執筆→批評→改善という一連の手順に分解できます。
-   タスクを実行するエージェントと、それを評価しフィードバックするエージェントを `while` ループで回し、評価者が所定の基準を満たしたと判断するまで続けます。
-   複数のエージェントを並列に実行します。たとえば Python の基本コンポーネントである `asyncio.gather` などを用います。相互依存しない複数タスクがある場合、速度向上に有用です。

`examples/agent_patterns` には多数の code examples があります。